<!DOCTYPE html>

<html>
<head>
  <title>offsets.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>

      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">


                <a class="source" href="explode.js.html">
                  explode.js
                </a>


                <a class="source" href="function.js.html">
                  function.js
                </a>


                <a class="source" href="index.js.html">
                  index.js
                </a>


                <a class="source" href="join-sources.js.html">
                  join-sources.js
                </a>


                <a class="source" href="language.js.html">
                  language.js
                </a>


                <a class="source" href="offsets.js.html">
                  offsets.js
                </a>


                <a class="source" href="pack.js.html">
                  pack.js
                </a>


                <a class="source" href="parse.all.js.html">
                  parse.all.js
                </a>


                <a class="source" href="parse.inc.js.html">
                  parse.inc.js
                </a>


                <a class="source" href="parse.sketch.js.html">
                  parse.sketch.js
                </a>


                <a class="source" href="parser.js.html">
                  parser.js
                </a>


                <a class="source" href="pull.js.html">
                  pull.js
                </a>


                <a class="source" href="puller.js.html">
                  puller.js
                </a>


                <a class="source" href="push.js.html">
                  push.js
                </a>


                <a class="source" href="qualify.js.html">
                  qualify.js
                </a>


                <a class="source" href="require.js.html">
                  require.js
                </a>


                <a class="source" href="serialize.all.js.html">
                  serialize.all.js
                </a>


                <a class="source" href="serialize.inc.js.html">
                  serialize.inc.js
                </a>


                <a class="source" href="stream.js.html">
                  stream.js
                </a>


                <a class="source" href="tokenizer.js.html">
                  tokenizer.js
                </a>


                <a class="source" href="transforms.js.html">
                  transforms.js
                </a>


                <a class="source" href="transmogrifier.js.html">
                  transmogrifier.js
                </a>


                <a class="source" href="unpack.js.html">
                  unpack.js
                </a>


                <a class="source" href="variables.js.html">
                  variables.js
                </a>


                <a class="source" href="writer.js.html">
                  writer.js
                </a>

            </div>
          </div>
        </li>
      </ul>

    <ul class="sections">

          <li id="title">
              <div class="annotation">
                  <h1>offsets.js</h1>
              </div>
          </li>



        <li id="section-1">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>

            </div>

            <div class="content"><div class='highlight'><pre><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">resolveAlternation</span> (<span class="hljs-params">pattern, incoming</span>) </span>{
    <span class="hljs-keyword">if</span> (pattern.some(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">field</span>) </span>{ <span class="hljs-keyword">return</span> field.alternation })) {
        <span class="hljs-keyword">var</span> resolved = []
        <span class="hljs-keyword">var</span> alternates = compiled.pattern.slice()
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; alternates.length; i++) {
            <span class="hljs-keyword">var</span> field = alternates[i]
            <span class="hljs-keyword">if</span> (field.alternation) {
                field = field.alternation[<span class="hljs-number">0</span>]
                <span class="hljs-keyword">if</span> (field.pattern[<span class="hljs-number">0</span>].packing) {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>, J = field.pattern[<span class="hljs-number">0</span>].packing.length; j &lt; J; j++) {
                        <span class="hljs-keyword">if</span> (field.pattern[<span class="hljs-number">0</span>].packing[j].named) {
                            field = field.pattern[<span class="hljs-number">0</span>].packing[j]
                        }
                    }
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-number">0</span>, J = field.pattern.length; j &lt; J; j++) {
                        <span class="hljs-keyword">if</span> (field.pattern[j].named) {
                            field = field.pattern[j]
                        }
                    }
                }
                <span class="hljs-keyword">var</span> value = incoming[field.name]

                field = alternates[i]
                <span class="hljs-keyword">for</span> (j = <span class="hljs-number">0</span>, J = field.alternation.length; j &lt; J; j++) {
                    <span class="hljs-keyword">var</span> alternate = field.alternation[j]
                    <span class="hljs-keyword">if</span> (alternate.write.minimum &lt;= value &amp;&amp;  value &lt;= alternate.write.maximum) {
                        <span class="hljs-keyword">break</span>
                    }
                }

                <span class="hljs-keyword">if</span> (alternate.failed) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'Cannot match branch.'</span>)
                }

                alternates.splice.apply(alternates, [ i--, <span class="hljs-number">1</span> ].concat(alternate.pattern))
                <span class="hljs-keyword">continue</span>
            }
            resolved.push(field)
        }
        <span class="hljs-keyword">return</span> resolved
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> pattern
    }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">offsetsOf</span> (<span class="hljs-params">buffer, offset</span>) </span>{
    <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(buffer)) buffer = <span class="hljs-keyword">new</span> Buffer(buffer)

    <span class="hljs-keyword">var</span> pattern = resolveAlternation(compiled.pattern, incoming)
    <span class="hljs-keyword">var</span> patternIndex = <span class="hljs-number">0</span>
    <span class="hljs-keyword">var</span> field = pattern[patternIndex]
    <span class="hljs-keyword">var</span> offset = offset == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : offset
    <span class="hljs-keyword">var</span> output, record

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dump</span> (<span class="hljs-params">record</span>) </span>{
        <span class="hljs-keyword">if</span> (buffer) {
            record.hex = buffer.slice(record.offset, record.offset + record.length).toString(<span class="hljs-string">'hex'</span>)
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">detokenize</span> (<span class="hljs-params">arrayed, count</span>) </span>{
         <span class="hljs-keyword">var</span> scalar = (field.signed &amp;&amp; field.type != <span class="hljs-string">'f'</span> ? <span class="hljs-string">'-'</span> : <span class="hljs-string">''</span>) +
                       field.endianness + field.bits +
                      (field.type == <span class="hljs-string">'n'</span> ? <span class="hljs-string">''</span> : field.type)
        <span class="hljs-keyword">if</span> (field.padding) {
            <span class="hljs-keyword">var</span> buffer = <span class="hljs-keyword">new</span> Buffer(field.bits / <span class="hljs-number">8</span>), pad = field.padding
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = buffer.length <span class="hljs-number">-1</span>; i != <span class="hljs-number">-1</span>; i--) {
                buffer[i] = pad &amp; <span class="hljs-number">0xff</span>
                pad &gt;&gt;&gt; <span class="hljs-number">8</span>
            }
            scalar += <span class="hljs-string">'{0x'</span> + buffer.toString(<span class="hljs-string">'hex'</span>) + <span class="hljs-string">'}'</span>
        }
        <span class="hljs-keyword">if</span> (arrayed) {
            <span class="hljs-keyword">if</span> (count) {
                <span class="hljs-keyword">return</span> count.pattern + <span class="hljs-string">'/'</span> + scalar
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.terminator) {
                <span class="hljs-keyword">if</span> (field.terminator[<span class="hljs-number">0</span>]) {</pre></div></div>

        </li>


        <li id="section-2">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>TODO: I’d prefer hex: b8z<0x0d0a>.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                    <span class="hljs-keyword">return</span> scalar + <span class="hljs-string">'z&lt;'</span> + field.terminator.join(<span class="hljs-string">','</span>) + <span class="hljs-string">'&gt;'</span>
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-keyword">return</span> scalar + <span class="hljs-string">'z'</span>
                }
            } <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">return</span> scalar + <span class="hljs-string">'['</span> + field.repeat + <span class="hljs-string">']'</span>
            }
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.packing) {
            <span class="hljs-keyword">return</span> scalar + <span class="hljs-string">'{'</span> + field.packing.map(<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">field</span>) </span>{
                <span class="hljs-keyword">return</span> (field.signed ? <span class="hljs-string">'-'</span> : <span class="hljs-string">''</span>) + field.endianness + field.bits
            }).join(<span class="hljs-string">','</span>) + <span class="hljs-string">'}'</span>
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">return</span> scalar
        }
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_element</span> (<span class="hljs-params">container, index</span>) </span>{
        <span class="hljs-keyword">var</span> value = field.arrayed ? incoming[field.name][index] : incoming[field.name]
        <span class="hljs-keyword">var</span> record =  { <span class="hljs-attr">name</span>: field.name,
                        <span class="hljs-attr">pattern</span>: detokenize(),
                        <span class="hljs-attr">value</span>: value,
                        <span class="hljs-attr">offset</span>: offset,
                        <span class="hljs-attr">length</span>: field.bits / <span class="hljs-number">8</span> }
        <span class="hljs-keyword">if</span> (!field.named) <span class="hljs-keyword">delete</span> record.name; <span class="hljs-comment">// add then remove for the sake of order.</span>
        <span class="hljs-keyword">if</span> (field.endianness == <span class="hljs-string">'x'</span>) <span class="hljs-keyword">delete</span> record.value
        <span class="hljs-keyword">if</span> (field.arrayed) {
            <span class="hljs-keyword">delete</span> record.name
            container.value[index] = record
        } <span class="hljs-keyword">else</span> {
            container[index] = record
        }
        dump(record)
        <span class="hljs-keyword">return</span> record.length
    }

    output = []
    <span class="hljs-keyword">while</span> (field) {
        <span class="hljs-keyword">if</span> (field.lengthEncoding) {
            <span class="hljs-keyword">var</span> start = offset
            <span class="hljs-keyword">var</span> element = pattern[++patternIndex]
            <span class="hljs-keyword">var</span> record = { <span class="hljs-attr">name</span>: element.name, <span class="hljs-attr">value</span>: [], <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span> }
            output.push(record)
            <span class="hljs-keyword">var</span> value = incoming[element.name]
            offset += _element(record, <span class="hljs-string">'count'</span>)
            record.count.value = value.length
            field = element
            record.pattern = detokenize(<span class="hljs-literal">true</span>, record.count)
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = value.length; i &lt; I; i++) {
                offset += _element(record, i)
            }
            record.length = offset - start
            dump(record)
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.terminator) {
            <span class="hljs-keyword">var</span> start = offset,
                    record = { <span class="hljs-attr">name</span>: field.name, <span class="hljs-attr">pattern</span>: detokenize(<span class="hljs-literal">true</span>), <span class="hljs-attr">value</span>: [], <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span> },
                    value = incoming[field.name]
            output.push(record)
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = value.length; i &lt; I; i++) {
                offset += _element(record, i)
            }
            record.terminator = { <span class="hljs-attr">value</span>: field.terminator.slice(),
                                                        <span class="hljs-attr">offset</span>: offset,
                                                        <span class="hljs-attr">length</span>: field.terminator.length,
                                                        <span class="hljs-attr">hex</span>: <span class="hljs-keyword">new</span> Buffer(field.terminator).toString(<span class="hljs-string">'hex'</span>) }
            offset += field.terminator.length
            record.length = offset - start
            dump(record)
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.arrayed) {
            <span class="hljs-keyword">var</span> start = offset,
                    value = incoming[field.name],</pre></div></div>

        </li>


        <li id="section-3">
            <div class="annotation">

              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>FIXME: offset is not zero. fix here and above.</p>

            </div>

            <div class="content"><div class='highlight'><pre>                    record = { <span class="hljs-attr">name</span>: field.name, <span class="hljs-attr">pattern</span>: detokenize(<span class="hljs-literal">true</span>), <span class="hljs-attr">value</span>: [], <span class="hljs-attr">offset</span>: <span class="hljs-number">0</span> }
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = field.repeat; i &lt; I; i++) {
                offset += _element(record, i)
            }
            record.length = offset - start
            dump(record)
            output.push(record)
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (field.packing) {
            record = { <span class="hljs-attr">pattern</span>: detokenize(),
                                  <span class="hljs-attr">value</span>: [],
                                  <span class="hljs-attr">offset</span>: offset,
                                  <span class="hljs-attr">length</span>: field.bits / <span class="hljs-number">8</span> }
            <span class="hljs-keyword">var</span> bit = <span class="hljs-number">0</span>, hex = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">1</span>)
            <span class="hljs-keyword">var</span> packing = field.packing
            <span class="hljs-keyword">var</span> start = offset
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>, I = packing.length; i &lt; I; i++) {
                field = packing[i]
                <span class="hljs-keyword">var</span> element = {
                    <span class="hljs-attr">name</span>: field.name,
                    <span class="hljs-attr">pattern</span>: detokenize(),
                    <span class="hljs-attr">value</span>: incoming[field.name],
                    <span class="hljs-attr">bit</span>: bit,
                    <span class="hljs-attr">bits</span>: field.bits
                }
                <span class="hljs-keyword">if</span> (!field.named) <span class="hljs-keyword">delete</span> element.name
                <span class="hljs-keyword">if</span> (field.endianness == <span class="hljs-string">'x'</span>) <span class="hljs-keyword">delete</span> element.value
                record.value.push(element)
                <span class="hljs-keyword">if</span> (buffer) {
                    element.hex = <span class="hljs-string">''</span>
                    element.binary = <span class="hljs-string">''</span>
                    <span class="hljs-keyword">var</span> left = bit % <span class="hljs-number">8</span>, right = (<span class="hljs-number">8</span> - ((bit + field.bits) % <span class="hljs-number">8</span>)) &amp; <span class="hljs-number">7</span>, b
                    <span class="hljs-keyword">var</span> mask = <span class="hljs-number">0xff</span> &gt;&gt;&gt; (bit % <span class="hljs-number">8</span>)
                    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j = <span class="hljs-built_in">Math</span>.floor(bit / <span class="hljs-number">8</span>), J = <span class="hljs-built_in">Math</span>.ceil((bit + field.bits) / <span class="hljs-number">8</span>); j &lt; J; j++) {
                        b = buffer[offset + j]
                        element.binary +=  (<span class="hljs-string">'0000000'</span> + b.toString(<span class="hljs-string">'2'</span>)).slice(<span class="hljs-number">-8</span>).substring(left)
                        hex[<span class="hljs-number">0</span>] = buffer[offset + j] &amp; (<span class="hljs-number">0xff</span> &gt;&gt;&gt; left)
                        left = <span class="hljs-number">0</span>
                        mask = <span class="hljs-number">0xff</span>
                        <span class="hljs-keyword">if</span> (j == J - <span class="hljs-number">1</span>) {
                            hex[<span class="hljs-number">0</span>] &amp;= (<span class="hljs-number">0xff</span> &lt;&lt; right)
                            element.binary = element.binary.substring(<span class="hljs-number">0</span>, element.binary.length - right)
                        }
                        element.hex += hex.toString(<span class="hljs-string">'hex'</span>)
                    }
                }
                bit += field.bits
            }
            dump(record)
            output.push(record)
        } <span class="hljs-keyword">else</span> {
            offset += _element(output, output.length)
        }
        field = pattern[++patternIndex]
    }
    <span class="hljs-keyword">return</span> output
}</pre></div></div>

        </li>

    </ul>
  </div>
</body>
</html>
